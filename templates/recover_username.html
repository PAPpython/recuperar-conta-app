from flask import Flask, render_template, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
import os
import time
import hashlib
import secrets

# ================= APP =================
app = Flask(__name__)
CORS(app)

BASE_DIR = os.path.abspath(os.path.dirname(__file__))

# ================= CONFIG =================
app.config["SECRET_KEY"] = "recuperar-secret"
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///" + os.path.join(BASE_DIR, "users.db")
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False

# ================= DB =================
db = SQLAlchemy(app)

# ================= MODELO USER =================
class User(db.Model):
    __tablename__ = "user"

    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True)
    email = db.Column(db.String(120), unique=True)
    password = db.Column(db.String(128))

# ================= MODELO CÓDIGOS =================
class RecoveryCode(db.Model):
    __tablename__ = "recovery_code"

    id = db.Column(db.Integer, primary_key=True)
    code = db.Column(db.String(64), unique=True, nullable=False)
    type = db.Column(db.String(20))
    expires = db.Column(db.Integer)

CODE_EXPIRATION = 300  # 5 minutos

# ================= UTILS =================
def hash_password(p):
    return hashlib.sha256(p.encode()).hexdigest()

def generate_code():
    return secrets.token_hex(16)

# ================= INIT DB (SEM APAGAR NADA) =================
with app.app_context():
    db.create_all()   # <- cria recovery_code se não existir

# ================= ROTAS =================
@app.route("/")
def index():
    return render_template("index.html")

@app.route("/recover-password")
def recover_password():
    return render_template("recover_password.html")

@app.route("/recover-username")
def recover_username():
    return render_template("recover_username.html")

# ================= GERAR CÓDIGOS =================
@app.route("/api/generate-password-code", methods=["GET"])
def generate_password_code():
    try:
        code = generate_code()
        expires = int(time.time() + CODE_EXPIRATION)

        db.session.add(RecoveryCode(code=code, type="password", expires=expires))
        db.session.commit()

        return jsonify(status="ok", code=code, expires=CODE_EXPIRATION)

    except Exception as e:
        return jsonify(status="error", msg="Erro interno"), 200

@app.route("/api/generate-username-code", methods=["GET"])
def generate_username_code():
    try:
        code = generate_code()
        expires = int(time.time() + CODE_EXPIRATION)

        db.session.add(RecoveryCode(code=code, type="username", expires=expires))
        db.session.commit()

        return jsonify(status="ok", code=code, expires=CODE_EXPIRATION)

    except Exception:
        return jsonify(status="error", msg="Erro interno"), 200

# ================= VALIDAR PASSWORD =================
@app.route("/api/validate-password-code", methods=["POST"])
def validate_password_code():
    try:
        data = request.get_json(force=True)
        code = (data.get("code") or "").strip()

        if not code:
            return jsonify(status="error", msg="Código vazio")

        rec = RecoveryCode.query.filter_by(code=code, type="password").first()
        if not rec:
            return jsonify(status="error", msg="Código inválido")

        if time.time() > rec.expires:
            db.session.delete(rec)
            db.session.commit()
            return jsonify(status="error", msg="Código expirado")

        return jsonify(status="ok")

    except Exception:
        return jsonify(status="error", msg="Erro interno"), 200

# ================= VALIDAR USERNAME =================
@app.route("/api/validate-username-code", methods=["POST"])
def validate_username_code():
    try:
        data = request.get_json(force=True)
        code = (data.get("code") or "").strip()

        if not code:
            return jsonify(status="error", msg="Código vazio")

        rec = RecoveryCode.query.filter_by(code=code, type="username").first()
        if not rec:
            return jsonify(status="error", msg="Código inválido")

        if time.time() > rec.expires:
            db.session.delete(rec)
            db.session.commit()
            return jsonify(status="error", msg="Código expirado")

        return jsonify(status="ok")

    except Exception:
        return jsonify(status="error", msg="Erro interno"), 200

# ================= START =================
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
